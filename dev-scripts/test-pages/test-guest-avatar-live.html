<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guest Avatar Testing - Dev Scripts</title>
  <link rel="stylesheet" href="/dev-scripts/shared/ui-framework.css">
  <style>
    .test-section {
      margin-bottom: var(--space-xl);
    }
    
    .test-button {
      margin-right: var(--space-sm);
      margin-bottom: var(--space-sm);
    }
    
    .results-area {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      min-height: 200px;
      font-family: var(--font-mono);
      font-size: 0.875rem;
      white-space: pre-wrap;
      overflow-y: auto;
    }
    
    .avatar-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: var(--space-md);
      margin-top: var(--space-md);
    }
    
    .avatar-preview {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      text-align: center;
    }
    
    .avatar-preview img {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-sm);
    }
    
    .avatar-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .console-output {
      background-color: var(--bg-tertiary);
      border-left: 3px solid var(--text-accent);
      padding: var(--space-md);
      margin: var(--space-md) 0;
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 0.875rem;
    }
    
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: var(--space-sm);
    }
    
    .status-ready { background-color: var(--success); }
    .status-testing { background-color: var(--warning); }
    .status-error { background-color: var(--error); }
  </style>
</head>
<body class="dev-page">
  <div class="dev-container">
    <header class="dev-header">
      <a href="/dev-scripts" class="back-link">‚Üê Dev Scripts</a>
      <h1>üé® Guest Avatar Testing</h1>
    </header>

    <main class="dev-content">
    <div class="dev-card">
      <h2 class="dev-card-title">Guest Avatar Integration Testing</h2>
      <p class="dev-card-description">
        Interactive testing interface for the guest avatar generation system.
        Test avatar creation, localStorage persistence, and UI integration.
      </p>
      
      <div class="dev-status dev-status-info mb-md">
        <span class="status-indicator status-ready"></span>
        System ready for testing
      </div>
    </div>

    <!-- Test Controls -->
    <section class="test-section">
      <div class="dev-card">
        <h3 class="dev-card-title">üß™ Test Controls</h3>
        
        <div style="margin-bottom: var(--space-lg);">
          <button id="testCreation" class="dev-button dev-button-primary test-button">
            Create New Guest
          </button>
          <button id="testStorage" class="dev-button test-button">
            Check localStorage
          </button>
          <button id="testUISwitch" class="dev-button test-button">
            Test UI Switch
          </button>
          <button id="clearResults" class="dev-button dev-button-warning test-button">
            Clear Results
          </button>
        </div>
        
        <div class="console-output">
          <strong>üí° Test Instructions:</strong><br>
          1. <strong>Create New Guest</strong> - Tests API guest creation with avatar generation<br>
          2. <strong>Check localStorage</strong> - Verifies guest session persistence<br>
          3. <strong>Test UI Switch</strong> - Simulates switching to guest mode in the main app<br><br>
          
          <strong>üîç What to Look For:</strong><br>
          ‚Ä¢ Avatar URLs are generated (data:image/svg+xml format)<br>
          ‚Ä¢ Guest sessions persist in localStorage<br>
          ‚Ä¢ Profile pictures display correctly<br>
          ‚Ä¢ No console errors during testing
        </div>
      </div>
    </section>

    <!-- Results Display -->
    <section class="test-section">
      <div class="dev-card">
        <h3 class="dev-card-title">üìä Test Results</h3>
        <div id="resultsArea" class="results-area text-secondary">
          Click a test button above to see results here...
        </div>
      </div>
    </section>

    <!-- Avatar Gallery -->
    <section class="test-section">
      <div class="dev-card">
        <h3 class="dev-card-title">üñºÔ∏è Avatar Gallery</h3>
        <p class="text-secondary mb-md">Generated guest avatars will appear here during testing:</p>
        <div id="avatarGallery" class="avatar-gallery">
          <div class="avatar-preview">
            <div style="width: 80px; height: 80px; background-color: var(--bg-tertiary); border: 2px dashed var(--border-primary); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: var(--text-muted); margin: 0 auto var(--space-sm);">
              ?
            </div>
            <div class="avatar-label">No avatars yet</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Console Code -->
    <section class="test-section">
      <div class="dev-card">
        <h3 class="dev-card-title">üíª Console Code Reference</h3>
        <p class="text-secondary">For manual testing, you can run these functions directly in the browser console:</p>
        
        <pre><code>// Create new guest with avatar
await testGuestCreation();

// Check localStorage for guest session
checkStoredGuest();

// Test UI switching (requires main app to be loaded)
testGuestSwitch();

// Clear all test data
clearTestData();</code></pre>
      </div>
    </section>
    </main>
  </div>

  <script>
    // Results area reference
    const resultsArea = document.getElementById('resultsArea');
    const avatarGallery = document.getElementById('avatarGallery');
    
    // Logging function
    function logResult(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = {
        'info': 'üí¨',
        'success': '‚úÖ',
        'error': '‚ùå',
        'warning': '‚ö†Ô∏è'
      }[type] || 'üí¨';
      
      resultsArea.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      resultsArea.scrollTop = resultsArea.scrollHeight;
      
      // Also log to console for debugging
      console.log(`Guest Avatar Test: ${message}`);
    }
    
    // Add avatar to gallery
    function addAvatarToGallery(avatarUrl, label) {
      // Remove placeholder if it exists
      const placeholder = avatarGallery.querySelector('.avatar-preview');
      if (placeholder && placeholder.textContent.includes('No avatars yet')) {
        avatarGallery.innerHTML = '';
      }
      
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'avatar-preview';
      avatarDiv.innerHTML = `
        <img src="${avatarUrl}" alt="${label}" />
        <div class="avatar-label">${label}</div>
      `;
      avatarGallery.appendChild(avatarDiv);
    }
    
    // Test functions - available globally for console use
    window.testGuestCreation = async () => {
      logResult('Starting guest creation test...', 'info');
      
      try {
        const response = await fetch('/api/guests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            customName: 'Test Monster Guest',
            sessionFingerprint: 'test_' + Date.now()
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        logResult(`Guest created: ID ${data.user?.id || 'unknown'}`, 'success');
        logResult(`Name: ${data.user?.displayName || 'unknown'}`, 'info');
        
        if (data.user?.profilePicture) {
          logResult('‚úì Avatar generated successfully', 'success');
          logResult(`Avatar length: ${data.user.profilePicture.length} characters`, 'info');
          
          // Add to gallery
          addAvatarToGallery(data.user.profilePicture, data.user.displayName || 'Test Guest');
        } else {
          logResult('‚úó No avatar found in response', 'error');
        }
        
        return data;
      } catch (error) {
        logResult(`Guest creation failed: ${error.message}`, 'error');
        return null;
      }
    };
    
    window.checkStoredGuest = () => {
      logResult('Checking localStorage for guest session...', 'info');
      
      try {
        const stored = localStorage.getItem('guest_session');
        if (stored) {
          const parsed = JSON.parse(stored);
          logResult('‚úì Guest session found in localStorage', 'success');
          logResult(`Guest ID: ${parsed.user?.id || 'unknown'}`, 'info');
          logResult(`Name: ${parsed.user?.displayName || 'unknown'}`, 'info');
          
          if (parsed.user?.profilePicture) {
            logResult('‚úì Avatar found in stored session', 'success');
            addAvatarToGallery(parsed.user.profilePicture, `${parsed.user.displayName} (stored)`);
          } else {
            logResult('‚úó No avatar in stored session', 'warning');
          }
          
          return parsed;
        } else {
          logResult('No guest session found in localStorage', 'warning');
          return null;
        }
      } catch (error) {
        logResult(`Error reading localStorage: ${error.message}`, 'error');
        return null;
      }
    };
    
    window.testGuestSwitch = () => {
      logResult('Testing UI guest mode switch...', 'info');
      
      // This test requires the main application to be loaded
      const userButton = document.querySelector('[title*="Select user"]');
      if (userButton) {
        logResult('‚úì User selector button found', 'success');
        // Continue with UI test logic...
      } else {
        logResult('‚ö†Ô∏è User selector not found - this test requires the main app', 'warning');
        logResult('Load this page from within the main application to test UI switching', 'info');
      }
    };
    
    window.clearTestData = () => {
      logResult('Clearing test data...', 'info');
      
      // Clear localStorage guest session
      try {
        localStorage.removeItem('guest_session');
        logResult('‚úì Cleared guest session from localStorage', 'success');
      } catch (error) {
        logResult(`Error clearing localStorage: ${error.message}`, 'error');
      }
      
      // Clear avatar gallery
      avatarGallery.innerHTML = `
        <div class="avatar-preview">
          <div style="width: 80px; height: 80px; background-color: var(--bg-tertiary); border: 2px dashed var(--border-primary); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: var(--text-muted); margin: 0 auto var(--space-sm);">
            ?
          </div>
          <div class="avatar-label">No avatars yet</div>
        </div>
      `;
      
      logResult('‚úì Gallery cleared', 'success');
    };
    
    // Button event listeners
    document.getElementById('testCreation').addEventListener('click', window.testGuestCreation);
    document.getElementById('testStorage').addEventListener('click', window.checkStoredGuest);
    document.getElementById('testUISwitch').addEventListener('click', window.testGuestSwitch);
    document.getElementById('clearResults').addEventListener('click', () => {
      resultsArea.textContent = '';
      logResult('Results cleared', 'info');
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      logResult('Guest Avatar Testing interface loaded', 'success');
      logResult('Ready for testing - click buttons above or use console functions', 'info');
    });
  </script>
</body>
</html>